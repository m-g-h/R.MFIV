---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# R.MFIV

<!-- badges: start -->
[![Travis build status](https://travis-ci.com/m-g-h/R.MFIV.svg?branch=master)](https://travis-ci.com/m-g-h/R.MFIV)
[![Codecov test coverage](https://codecov.io/gh/m-g-h/R.MFIV/branch/master/graph/badge.svg)](https://codecov.io/gh/m-g-h/R.MFIV?branch=master)
<!-- badges: end -->

R.MFIV is currently in development

## CBOE VIX Calculation

The approach of the VIX calculation, which is replicated below, is explained in the [CBOE VIX Whitepaper](http://www.cboe.com/micro/vix/vixwhite.pdf).

The VIX is defined as:
```{r echo=FALSE, out.width='45%', fig.align='center'}
knitr::include_graphics("man/figures/VIX_formulas.PNG")
```
where the term in brackets under the square root is a linear interpolation of two Implied Variances, which are given by the second formula.

In order to calculate the VIX and its individual variables, this package provides the following functionality:

1. Calculate the Risk-Free-Rate R `interpolate_rfr()`
2. Calculate the At-The-Money Forward Price F~0~ `CBOE_F_O()`
3. Calculate the At-The-Money Strike Price K~0~ `CBOE_K_0()`
4. Select the Option Quotes Q(K~i~) according to the CBOE Rule `CBOE_option_selection()`
5. Calculate the Implied Variance &sigma;^2^ `CBOE_sigma_sq()`
6. Do all of the above in one function `CBOE_VIX_variables()`
7. Determine the Expiration Terms ("near-" and "next-term") `CBOE_interpolation_terms()`
8. Interpolate the VIX using two Implied Variances `CBOE_VIX_index()`
9. Calculate Option Descriptives `option_descriptives()`


## 1. Short Walkthrough 
Load exemplary package data
```{r}
library(R.MFIV)
data(option_dataset)
option_dataset
```

We select an exemplary entry as an example. This observation will be our "near-term" contract. Also note that the `option_quotes` are a "nested" data.table themselves.
```{r}

t <- option_dataset$t[4]
exp <- option_dataset$exp[4]
option_quotes <- option_dataset$option_quotes[[4]]

option_quotes
```
Next we calculate the Risk-Free-Rate R
```{r}
library(lubridate)
R <- interpolate_rfr(date = as_date(t),
                     exp = exp,
                     ret_table = F)
R
```



Calculate At-The-Money Forward Price F~0~
```{r}
## Set expiration time to 4 PM
exp <- exp + hours(16)
## Calculate maturity in years
maturity <- time_length(exp-t,unit = "years")
## Calculate ATM Forward
F_0 <- CBOE_F_0(option_quotes = option_quotes,
                R = R,
                maturity = maturity)
F_0
```
Calculate At-The-Money Strike price K~0~
```{r}
K_0 <- CBOE_K_0(option_quotes = option_quotes,
                                 F_0 = F_0)
K_0
```

Select option quotes per CBOE rule
```{r}
option_quotes <- CBOE_option_selection(option_quotes = option_quotes,
                                       K_0 = K_0)
option_quotes

```
Calculate Implied Variance &sigma;^2^
```{r}
sigma_sq <- CBOE_sigma_sq(sel_option_quotes = option_quotes,
                       K_0 = K_0,
                       F_0 = F_0,
                       maturity = maturity,
                       R = R)
sigma_sq
```

Do the same for a second maturity, this time all at once. This observation will be our "next-term" contract.
```{r}
## Select observation 5
t2 <- option_dataset$t[5]
exp2 <- option_dataset$exp[5]
option_quotes2 <- option_dataset$option_quotes[[5]]

## Risk free rate
R2 <- interpolate_rfr(date = as_date(t2),
                     exp = exp2,
                     ret_table = F)

## Set expiration time to 4 PM
exp2 <- exp2 + hours(16)
## Calculate maturity in years
maturity2 <- time_length(exp2-t2,unit = "years")

## Calculate all VIX vars at once
VIX_vars <- CBOE_VIX_vars(option_quotes = option_quotes2,
              R = R2,
              maturity = maturity2,
              ret_vars = T)

VIX_vars
```

Calculate and interpolate the VIX index from both maturities
```{r}
CBOE_VIX_index(maturity = c(maturity, maturity2),
               sigma_sq = c(sigma_sq,VIX_vars$sigma_sq))
```
Calculate Option Descriptives, i.e. the strike price range and spacing in standard-deviation (SD) units of the used option quotes:
```{r}
price <- option_dataset$price[4]
option_descriptives(option_quotes = option_quotes,
                    K_0 = K_0,
                    R = R,
                    price = price,
                    maturity = maturity)
```

## 2. Processing a whole dataset (using data.table)

Calculate the Implied Variances for a complete dataset
```{r vix dataset example}
## Calculate risk-free-rate and maturity
option_dataset[, `:=`(R = interpolate_rfr(date = as_date(t),
                                          exp = exp),
                      maturity = time_length((exp + hours(16) - t),unit = "years"))]

## Calculate VIX for the whole dataset
option_dataset[, sigma_sq := mapply(CBOE_VIX_vars, option_quotes, R, maturity)]
option_dataset
```

If you want to keep the intermediate variables:

```{r vix dataset example all vars, eval=FALSE}
var_names <- c("F_0", "K_0", "n_put_raw", "n_call_raw", "n_put", "n_call", "sigma_sq")

## Function to convert the mapply result to a data.table
multicols <- function(matrix){
  data.table::as.data.table(t(matrix))[, lapply(.SD, unlist)]
}

## Calculate VIX for the whole dataset, including intermediate variables
option_dataset[, c("F_0", "K_0", "n_put_raw", "n_call_raw", "n_put", "n_call", "sigma_sq") := 
                 multicols(mapply(CBOE_VIX_vars,
                                  option_quotes, R, maturity,
                                  MoreArgs = list(ret_vars = T))
                           )]
option_dataset
```

Determine the expiration terms for the interpolation. 1 indicates the near-term, 2 the next-term option.
```{r}
## Weekly expiration terms
option_dataset[, `:=`(term_wk = sapply(maturity, CBOE_interpolation_terms,
                                       method = "weekly"),
                      term_mn = mapply(CBOE_interpolation_terms,
                                       maturity, as_date(t), as_date(exp),
                                       MoreArgs = list(method = "monthly"))
)]
```

Calculate the VIX indices
```{r}
## Weekly VIX
weekly <- option_dataset[!is.na(term_wk)][, .(VIX_wk = CBOE_VIX_index(maturity = maturity,
                                                                      sigma_sq = sigma_sq)),
                                          by = .(ticker, t)]

## Monthly VIX
monthly <- option_dataset[!is.na(term_mn)][, .(VIX_mn = CBOE_VIX_index(maturity = maturity,
                                                                       sigma_sq = sigma_sq)),
                                           by = .(ticker, t)]

VIX_data <- weekly[monthly, on = .(ticker, t)]

VIX_data
```

